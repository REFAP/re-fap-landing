<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nettoyage FAP 99€ - Trouvez votre solution | Re-FAP</title>
    <meta name="description" content="FAP bouché ? Nettoyage Re-FAP à 99-199€ vs remplacement 1500-2000€. Solution clé en main ou dépôt en magasin. Diagnostic, garantie 1 an.">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://refap.github.io/solutions-fap/">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Nettoyage FAP 99€ - Alternative au remplacement | Re-FAP">
    <meta property="og:description" content="Économisez jusqu'à 90% sur votre FAP. Nettoyage professionnel Re-FAP vs remplacement. Deux solutions adaptées.">
    <meta property="og:image" content="https://refap.github.io/assets/images/og-image-fap.jpg">
    <meta property="og:url" content="https://refap.github.io/solutions-fap/">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Nettoyage FAP 99€ - Alternative au remplacement">
    <meta name="twitter:description" content="Économisez jusqu'à 90% sur votre FAP. Solution clé en main ou dépôt en magasin.">
    <meta name="twitter:image" content="https://refap.github.io/assets/images/og-image-fap.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="assets/images/Re-Fap_Logo_Couleur.png" as="image">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.idgarages.com">
    <link rel="preconnect" href="https://refap.github.io">
    <link rel="dns-prefetch" href="https://www.idgarages.com">
    <link rel="dns-prefetch" href="https://refap.github.io">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Critical CSS inline -->
    <style>
        :root {
            --primary: #00a651;
            --primary-dark: #008844;
            --secondary: #ffc107;
            --danger: #dc3545;
            --dark: #1a1a1a;
            --gray: #6c757d;
            --light-gray: #f8f9fa;
            --white: #ffffff;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            color: var(--dark);
            line-height: 1.6;
            background: var(--white);
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: var(--white);
            box-shadow: var(--shadow-sm);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 40px;
        }

        .cta-header {
            background: var(--primary);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .cta-header:hover {
            background: var(--primary-dark);
        }

        /* Hero */
        .hero {
            background: linear-gradient(135deg, #f0f9f4 0%, var(--white) 100%);
            padding: 40px 0;
            text-align: center;
        }

        .hero h1 {
            font-size: 28px;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .hero-subtitle {
            font-size: 18px;
            color: var(--gray);
            margin-bottom: 20px;
        }

        .hero-badge {
            background: var(--secondary);
            color: var(--dark);
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* Quiz */
        .quiz-section {
            background: var(--white);
            padding: 40px 0;
        }

        .quiz-container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--light-gray);
            border-radius: 12px;
            padding: 30px;
        }

        .quiz-title {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .quiz-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .quiz-question {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border: none;
        }

        .quiz-question legend {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .quiz-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .quiz-option {
            flex: 1;
            min-width: 120px;
        }

        .quiz-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .quiz-option-label {
            display: block;
            padding: 12px 20px;
            background: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option input[type="radio"]:checked + .quiz-option-label {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .quiz-option input[type="radio"]:focus + .quiz-option-label {
            box-shadow: 0 0 0 3px rgba(0, 166, 81, 0.2);
        }

        .error {
            color: var(--danger);
            font-size: 14px;
            margin-top: 10px;
        }

        .quiz-submit {
            background: var(--primary);
            color: var(--white);
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-submit:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .modify-answers {
            text-align: center;
            margin-top: 15px;
        }

        .modify-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
        }

        /* Recommendation */
        .recommendation-section {
            display: none;
            background: #f0f9f4;
            padding: 40px 0;
            margin-top: 40px;
        }

        .recommendation-section.active {
            display: block;
        }

        .recommendation-box {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow-md);
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        .recommendation-title {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .recommendation-points {
            list-style: none;
            margin: 20px 0;
            text-align: left;
        }

        .recommendation-points li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
        }

        .recommendation-points li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
            font-size: 20px;
        }

        .recommendation-cta {
            display: inline-block;
            background: var(--primary);
            color: var(--white);
            padding: 15px 40px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .recommendation-cta:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .switch-option {
            margin-top: 20px;
            font-size: 14px;
            color: var(--gray);
        }

        .switch-btn {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
        }

        /* Solutions Cards */
        .solutions-section {
            padding: 60px 0;
            background: var(--white);
        }

        .solutions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .solution-card {
            background: var(--white);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .solution-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-5px);
        }

        .solution-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .solution-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .solution-price {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .solution-features {
            list-style: none;
            margin: 20px 0;
            text-align: left;
        }

        .solution-features li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .solution-features li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        .solution-cta {
            display: block;
            background: var(--primary);
            color: var(--white);
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .solution-cta:hover {
            background: var(--primary-dark);
        }

        /* Process */
        .process-section {
            background: var(--light-gray);
            padding: 60px 0;
        }

        .process-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .process-step {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }

        .step-number {
            background: var(--primary);
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
        }

        /* Trust */
        .trust-section {
            padding: 60px 0;
            background: var(--white);
            text-align: center;
        }

        .trust-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }

        .trust-metric {
            text-align: center;
        }

        .trust-metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .trust-metric-label {
            color: var(--gray);
            margin-top: 5px;
        }

        /* FAQ */
        .faq-section {
            background: var(--light-gray);
            padding: 60px 0;
        }

        .faq-grid {
            max-width: 800px;
            margin: 0 auto;
            margin-top: 40px;
        }

        .faq-item {
            background: var(--white);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .faq-item summary {
            padding: 20px;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            position: relative;
        }

        .faq-item summary::after {
            content: '+';
            position: absolute;
            right: 20px;
            font-size: 24px;
            color: var(--primary);
        }

        .faq-item[open] summary::after {
            content: '−';
        }

        .faq-item p {
            padding: 0 20px 20px;
            color: var(--gray);
        }

        /* Sticky Bar */
        .sticky-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            display: none;
            z-index: 99;
        }

        .sticky-bar-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .sticky-btn {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .sticky-btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .sticky-btn-secondary {
            background: var(--light-gray);
            color: var(--dark);
        }

        /* Footer */
        footer {
            background: var(--dark);
            color: var(--white);
            padding: 40px 0;
            text-align: center;
        }

        .footer-note {
            color: #999;
            margin-top: 20px;
            font-size: 14px;
        }

        /* Methodology */
        .methodology {
            background: var(--light-gray);
            padding: 20px;
            margin-top: 40px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--gray);
            text-align: center;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .sticky-bar {
                display: block;
            }

            .hero h1 {
                font-size: 24px;
            }

            .solutions-grid {
                grid-template-columns: 1fr;
            }

            .process-steps {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* No-JS fallback */
        .no-js-fallback {
            background: var(--secondary);
            color: var(--dark);
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .no-js-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Hidden by default */
        [hidden] {
            display: none !important;
        }
        
        /* Handoff Modal Styles */
        .handoff-modal[hidden] {
            display: none;
        }
        
        .handoff-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
        }
        
        .handoff-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .handoff-dialog {
            position: relative;
            max-width: 600px;
            max-height: 90vh; /* Limite la hauteur à 90% de la fenêtre */
            margin: 5vh auto; /* Centre avec marges top/bottom */
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            outline: 0;
            overflow-y: auto; /* Scroll sur tout le dialog si nécessaire */
        }
        
        .handoff-close {
            position: sticky; /* Reste visible lors du scroll */
            float: right;
            top: -15px;
            margin: -15px -15px 10px 10px;
            border: 0;
            background: var(--white);
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
            z-index: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .handoff-close:hover {
            color: var(--dark);
            background: rgba(0, 0, 0, 0.05);
        }
        
        #handoff-title {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 22px;
            clear: both; /* Pour éviter le chevauchement avec le close */
        }
        
        .handoff-steps {
            margin: 20px 0 20px 20px;
            counter-reset: step-counter;
            /* PAS de height fixe ou overflow ici */
        }
        
        .handoff-steps li {
            counter-increment: step-counter;
            position: relative;
            padding-left: 40px;
            margin-bottom: 25px; /* Plus d'espace entre les étapes */
            line-height: 1.6;
        }
        
        .handoff-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Styles pour les sous-textes des étapes */
        .handoff-steps li span {
            display: block;
            font-size: 14px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .handoff-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
            border: 0;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark);
            border: 0;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .handoff-optout {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--gray);
        }
        
        @media (max-width: 600px) {
            .handoff-dialog {
                margin: 2vh 10px;
                padding: 20px;
                max-height: 95vh; /* Plus d'espace sur mobile */
            }
            
            .handoff-actions {
                flex-direction: column;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
                text-align: center;
            }
            
            .handoff-steps {
                margin-left: 10px;
            }
        }
    </style>
    
    <!-- Structured Data: Service -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Service",
        "name": "Re-FAP Nettoyage FAP",
        "description": "Service de nettoyage professionnel de FAP, alternative économique au remplacement",
        "provider": {
            "@type": "Organization",
            "name": "Re-FAP",
            "url": "https://re-fap.fr"
        },
        "areaServed": "France",
        "offers": {
            "@type": "Offer",
            "priceRange": "99€ - 199€",
            "availability": "https://schema.org/InStock",
            "description": "Prix nettoyage hors main-d'œuvre"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "reviewCount": "10000",
            "bestRating": "5"
        }
    }
    </script>
    
    <!-- Structured Data: FAQ -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "Combien coûte le nettoyage FAP au total ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Le nettoyage Re-FAP coûte 99-199€. Pour la solution clé en main en garage, ajoutez la main-d'œuvre (variable selon véhicule). Pour le dépôt en magasin, c'est le prix du nettoyage seul si vous gérez le démontage/remontage."
                }
            },
            {
                "@type": "Question",
                "name": "Mon véhicule passera-t-il le contrôle technique ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Oui, le nettoyage Re-FAP restaure 98% de l'efficacité d'origine. Votre système antipollution sera conforme pour le CT et les zones ZFE."
                }
            },
            {
                "@type": "Question",
                "name": "Quelle est la durée de l'intervention ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "En garage partenaire : généralement une journée tout compris. En dépôt magasin : 4h si magasin équipé, 48h sinon (nettoyage seul, hors démontage/remontage)."
                }
            },
            {
                "@type": "Question",
                "name": "Que couvre la garantie ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "1 an sur le nettoyage Re-FAP. En garage, la garantie couvre le pack complet (pièces et main-d'œuvre). En dépôt magasin, elle couvre uniquement le nettoyage."
                }
            },
            {
                "@type": "Question",
                "name": "Et si ce n'est pas le FAP ?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Le diagnostic en garage permettra d'identifier le vrai problème (capteur, vanne EGR, etc.) et de vous proposer la bonne solution."
                }
            }
        ]
    }
    </script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <img src="assets/images/Re-Fap_Logo_Couleur.jpg" alt="Re-FAP - Technologie de nettoyage FAP" width="160" height="40" loading="eager" decoding="async">
                </div>
                <a href="#quiz" class="cta-header" data-ga4_event="cta_header_quiz">Trouvez votre solution</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-badge">💰 Économisez jusqu'à 90%</div>
            <h1>FAP bouché ? Avant de remplacer à 1 500-2 000€, vérifiez si un nettoyage professionnel suffit</h1>
            <p class="hero-subtitle">
                Le plus souvent, oui. Nettoyage Re-FAP : 99-199€* • Garantie 1 an • 10 000+ clients satisfaits*
            </p>
            
            <!-- Ajout META AI : Avantages clairs -->
            <div style="display: flex; justify-content: center; gap: 30px; margin: 25px 0; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--primary); font-size: 20px;">✓</span>
                    <span>Diagnostic précis</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--primary); font-size: 20px;">✓</span>
                    <span>2 solutions adaptées</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--primary); font-size: 20px;">✓</span>
                    <span>Garantie 1 an</span>
                </div>
            </div>
            
            <!-- CTA principal du hero -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="#quiz" style="background: var(--primary); color: var(--white); padding: 15px 40px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 18px; display: inline-block; box-shadow: var(--shadow-md);" data-ga4_event="cta_hero_quiz">
                    Trouvez votre solution en 30 secondes →
                </a>
            </div>
            
            <p style="font-size: 12px; color: var(--gray); margin-top: 15px;">*Données internes 2023-2024. Prix nettoyage hors main-d'œuvre.</p>
        </div>
    </section>

    <!-- FAQ Rapide META AI - Réduction du rebond -->
    <section style="background: var(--white); padding: 30px 0; border-top: 1px solid #e0e0e0;">
        <div class="container">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 25px; font-size: 22px; color: var(--dark);">
                    💡 Réponses immédiates à vos questions
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px;">
                        <h3 style="font-size: 16px; margin-bottom: 10px; color: var(--primary);">
                            <span style="font-size: 20px;">🔧</span> Qu'est-ce qu'un FAP ?
                        </h3>
                        <p style="font-size: 14px; color: var(--gray);">
                            Le filtre à particules (FAP) est un dispositif qui réduit les émissions polluantes des véhicules diesel. Il se bouche avec le temps.
                        </p>
                    </div>
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px;">
                        <h3 style="font-size: 16px; margin-bottom: 10px; color: var(--primary);">
                            <span style="font-size: 20px;">⚡</span> Pourquoi nettoyer mon FAP ?
                        </h3>
                        <p style="font-size: 14px; color: var(--gray);">
                            Un FAP bouché entraîne perte de puissance, surconsommation et risque de panne. Le nettoyage coûte 10x moins cher que le remplacement.
                        </p>
                    </div>
                    <div style="background: var(--light-gray); padding: 20px; border-radius: 8px;">
                        <h3 style="font-size: 16px; margin-bottom: 10px; color: var(--primary);">
                            <span style="font-size: 20px;">⏱️</span> Combien de temps ?
                        </h3>
                        <p style="font-size: 14px; color: var(--gray);">
                            En garage : 1 journée tout compris. En dépôt magasin : 4h si équipé, 48h sinon (nettoyage seul).
                        </p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <a href="#quiz" style="background: var(--primary); color: var(--white); padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block;">
                        Découvrir ma solution personnalisée →
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Micro Quiz Section -->
    <section id="quiz" class="quiz-section">
        <div class="container">
            <div class="quiz-container">
                <h2 class="quiz-title">🎯 Trouvez votre solution en 3 questions</h2>
                
                <form id="micro-quiz" class="quiz-form">
                    <!-- Question 1 -->
                    <fieldset class="quiz-question">
                        <legend>Votre FAP est-il déjà démonté ?</legend>
                        <div class="quiz-options">
                            <div class="quiz-option">
                                <input type="radio" id="q1-yes" name="q1" value="yes" required>
                                <label for="q1-yes" class="quiz-option-label">Oui</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" id="q1-no" name="q1" value="no">
                                <label for="q1-no" class="quiz-option-label">Non</label>
                            </div>
                        </div>
                        <p class="error" id="q1-error" role="alert" aria-live="assertive" tabindex="-1" hidden>Merci de sélectionner une option.</p>
                    </fieldset>

                    <!-- Question 2 -->
                    <fieldset class="quiz-question">
                        <legend>Vous préférez une solution clé en main en garage ?</legend>
                        <div class="quiz-options">
                            <div class="quiz-option">
                                <input type="radio" id="q2-yes" name="q2" value="yes" required>
                                <label for="q2-yes" class="quiz-option-label">Oui</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" id="q2-no" name="q2" value="no">
                                <label for="q2-no" class="quiz-option-label">Non</label>
                            </div>
                        </div>
                        <p class="error" id="q2-error" role="alert" aria-live="assertive" tabindex="-1" hidden>Merci de sélectionner une option.</p>
                    </fieldset>

                    <!-- Question 3 -->
                    <fieldset class="quiz-question">
                        <legend>Êtes-vous à l'aise avec la mécanique (démontage/remontage) ?</legend>
                        <div class="quiz-options">
                            <div class="quiz-option">
                                <input type="radio" id="q3-yes" name="q3" value="yes" required>
                                <label for="q3-yes" class="quiz-option-label">Oui</label>
                            </div>
                            <div class="quiz-option">
                                <input type="radio" id="q3-no" name="q3" value="no">
                                <label for="q3-no" class="quiz-option-label">Non</label>
                            </div>
                        </div>
                        <p class="error" id="q3-error" role="alert" aria-live="assertive" tabindex="-1" hidden>Merci de sélectionner une option.</p>
                    </fieldset>

                    <button type="submit" class="quiz-submit">Voir ma recommandation →</button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="showDefaultRecommendation(); return false;" style="color: var(--gray); text-decoration: underline; font-size: 14px;">
                            Je ne sais pas / Orientez-moi vers la meilleure solution
                        </a>
                    </div>
                </form>
                
                <div class="modify-answers" id="modify-section" hidden>
                    <a href="#quiz" class="modify-link" onclick="resetQuiz()">Modifier mes réponses</a>
                </div>
                
                <!-- No-JS Fallback -->
                <noscript>
                    <div class="no-js-fallback">
                        <p><strong>JavaScript est désactivé.</strong></p>
                        <p>Choisissez directement votre solution :</p>
                        <div class="no-js-buttons">
                            <a href="https://www.idgarages.com/prestations/re-fap?utm_source=refap&utm_medium=site&utm_campaign=fap-diagnostic" 
                               class="solution-cta">
                                Solution clé en main
                            </a>
                            <a href="https://refap.github.io/carter-cash-refap/?utm_source=refap&utm_medium=site&utm_campaign=fap-depot" 
                               class="solution-cta">
                                Dépôt en magasin
                            </a>
                        </div>
                    </div>
                </noscript>
            </div>
        </div>
    </section>

    <!-- Recommendation Section -->
    <section id="recommendation" class="recommendation-section" aria-live="polite">
        <div class="container">
            <div class="recommendation-box">
                <h2 class="recommendation-title">✅ Votre recommandation personnalisée</h2>
                <p id="recommendation-text"></p>
                <ul class="recommendation-points" id="recommendation-points">
                </ul>
                <a href="#" id="primary-cta" class="recommendation-cta" 
                   data-gtm="cta_primary" 
                   data-ga4_event="">
                    Accéder à la solution →
                </a>
                <div class="switch-option">
                    <p>Recommandation basée sur vos réponses (modifiable à tout moment)</p>
                    <button class="switch-btn" onclick="switchOption()">Voir l'autre option</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Solutions Section -->
    <section class="solutions-section">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 40px;">Deux solutions adaptées à vos besoins</h2>
            
            <div class="solutions-grid">
                <!-- Solution A: Clé en main -->
                <div class="solution-card">
                    <div class="solution-icon">🔧</div>
                    <h3 class="solution-title">Clé en main (garage partenaire)</h3>
                    <div class="solution-price">Devis personnalisé</div>
                    <ul class="solution-features">
                        <li>Diagnostic FAP professionnel</li>
                        <li>Nettoyage Re-FAP si nécessaire</li>
                        <li>Démontage et remontage inclus</li>
                        <li>Réinitialisation calculateur incluse</li>
                        <li>Garantie 1 an pack complet*</li>
                    </ul>
                    <a href="https://www.idgarages.com/fr-fr/prestations/diagnostic-electronique?utm_source=re-fap&utm_medium=partenariat&utm_campaign=diagnostic-electronique&ept-publisher=re-fap&ept-name=re-fap-diagnostic-electronique" 
                       class="solution-cta"
                       target="_blank"
                       rel="noopener noreferrer"
                       data-gtm="cta_idgarages"
                       data-ga4_event="cta_idgarages_click">
                        Comparer les garages →
                    </a>
                </div>

                <!-- Solution B: Dépôt magasin -->
                <div class="solution-card">
                    <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                        <img src="assets/images/logo carter cash.jpg" alt="Carter-Cash" width="120" height="50" loading="lazy" decoding="async">
                    </div>
                    <h3 class="solution-title">Dépôt en magasin (FAP déjà démonté)</h3>
                    <div class="solution-price">99-199€*</div>
                    <ul class="solution-features">
                        <li>Dépôt FAP déjà démonté</li>
                        <li>Nettoyage Re-FAP certifié</li>
                        <li>94 magasins en France</li>
                        <li>Sans rendez-vous</li>
                        <li>Garantie 1 an nettoyage*</li>
                    </ul>
                    <a href="https://refap.github.io/carter-cash-refap/?utm_source=refap&utm_medium=site&utm_campaign=fap-depot" 
                       class="solution-cta"
                       target="_blank"
                       rel="noopener noreferrer"
                       data-gtm="cta_cartercash"
                       data-ga4_event="cta_cartercash_click">
                        Voir les magasins →
                    </a>
                </div>
            </div>
            
            <p style="text-align: center; margin-top: 30px; color: var(--gray); font-size: 14px;">
                *Prix nettoyage hors main-d'œuvre. Conditions de garantie détaillées sur chaque site partenaire.
            </p>
        </div>
    </section>

    <!-- Process Section -->
    <section class="process-section">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 40px;">Comment ça se passe ?</h2>
            
            <div class="process-steps">
                <div class="process-step">
                    <div class="step-number">1</div>
                    <h3>🔍 Diagnostic</h3>
                    <p>Vérification codes défauts et état FAP</p>
                    <p style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                        <strong>Garage :</strong> inclus<br>
                        <strong>Dépôt :</strong> à votre charge
                    </p>
                </div>
                <div class="process-step">
                    <div class="step-number">2</div>
                    <h3>🔧 Nettoyage Re-FAP</h3>
                    <p>Technologie professionnelle certifiée</p>
                    <p style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                        98% d'efficacité retrouvée
                    </p>
                </div>
                <div class="process-step">
                    <div class="step-number">3</div>
                    <h3>✅ Réinitialisation</h3>
                    <p>Remise à zéro des compteurs FAP</p>
                    <p style="font-size: 12px; color: var(--gray); margin-top: 10px;">
                        <strong>Garage :</strong> incluse<br>
                        <strong>Dépôt :</strong> à votre charge
                    </p>
                </div>
            </div>
            
            <!-- Bloc de garanties META AI -->
            <div style="background: var(--primary); color: var(--white); padding: 30px; border-radius: 12px; margin-top: 40px; text-align: center;">
                <h3 style="font-size: 24px; margin-bottom: 20px;">🛡️ Nos Garanties</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div style="font-size: 36px; margin-bottom: 10px;">✓</div>
                        <h4 style="font-size: 16px; margin-bottom: 5px;">Garages Certifiés</h4>
                        <p style="font-size: 14px; opacity: 0.9;">Réseau IDGarages agréé Re-FAP</p>
                    </div>
                    <div>
                        <div style="font-size: 36px; margin-bottom: 10px;">1 AN</div>
                        <h4 style="font-size: 16px; margin-bottom: 5px;">Garantie</h4>
                        <p style="font-size: 14px; opacity: 0.9;">Sur le nettoyage Re-FAP</p>
                    </div>
                    <div>
                        <div style="font-size: 36px; margin-bottom: 10px;">0€</div>
                        <h4 style="font-size: 16px; margin-bottom: 5px;">Diagnostic Gratuit*</h4>
                        <p style="font-size: 14px; opacity: 0.9;">*Si nettoyage effectué</p>
                    </div>
                    <div>
                        <div style="font-size: 36px; margin-bottom: 10px;">CT</div>
                        <h4 style="font-size: 16px; margin-bottom: 5px;">Contrôle Technique OK</h4>
                        <p style="font-size: 14px; opacity: 0.9;">Conforme aux normes antipollution</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Trust Section -->
    <section class="trust-section">
        <div class="container">
            <h2>Ils nous font confiance</h2>
            
            <div class="trust-metrics">
                <div class="trust-metric">
                    <div class="trust-metric-value">10 000+</div>
                    <div class="trust-metric-label">FAP nettoyés*</div>
                </div>
                <div class="trust-metric">
                    <div class="trust-metric-value">98%</div>
                    <div class="trust-metric-label">Efficacité</div>
                </div>
                <div class="trust-metric">
                    <div class="trust-metric-value">1 500€</div>
                    <div class="trust-metric-label">Économie moyenne</div>
                </div>
                <div class="trust-metric">
                    <div class="trust-metric-value">4.8/5</div>
                    <div class="trust-metric-label">Note clients*</div>
                </div>
            </div>
            
            <div style="margin-top: 40px; padding: 30px; background: var(--light-gray); border-radius: 12px; max-width: 600px; margin-left: auto; margin-right: auto;">
                <p style="font-style: italic; font-size: 18px;">
                    "Mon garagiste voulait remplacer le FAP pour 1800€. Avec Re-FAP, nettoyage fait pour 350€ tout compris. 2 ans après, tout fonctionne parfaitement !"
                </p>
                <p style="margin-top: 15px; color: var(--gray);">— Marc D., client Re-FAP</p>
            </div>
            
            <!-- Témoignages supplémentaires META AI -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; max-width: 900px; margin-left: auto; margin-right: auto;">
                <div style="background: var(--white); padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
                    <div style="color: var(--primary); font-size: 24px; margin-bottom: 10px;">★★★★★</div>
                    <p style="font-size: 14px; color: var(--dark); margin-bottom: 10px;">
                        "Diagnostic clair et précis chez IDGarages. Le garage a confirmé que le nettoyage suffisait. Économie de 1200€ !"
                    </p>
                    <p style="font-size: 12px; color: var(--gray);">— Sophie L., via IDGarages</p>
                </div>
                <div style="background: var(--white); padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
                    <div style="color: var(--primary); font-size: 24px; margin-bottom: 10px;">★★★★★</div>
                    <p style="font-size: 14px; color: var(--dark); margin-bottom: 10px;">
                        "Dépôt chez Carter-Cash super simple. FAP nettoyé en 4h, récupéré le jour même. 150€ au lieu de 1500€ !"
                    </p>
                    <p style="font-size: 12px; color: var(--gray);">— Thomas R., bricoleur</p>
                </div>
                <div style="background: var(--white); padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
                    <div style="color: var(--primary); font-size: 24px; margin-bottom: 10px;">★★★★★</div>
                    <p style="font-size: 14px; color: var(--dark); margin-bottom: 10px;">
                        "Voyant FAP allumé depuis 2 mois. Après nettoyage Re-FAP, plus aucun problème. Contrôle technique OK !"
                    </p>
                    <p style="font-size: 12px; color: var(--gray);">— Ahmed B., client satisfait</p>
                </div>
            </div>
            
            <div class="methodology">
                <p><strong>Méthodologie :</strong></p>
                <p>*Données internes Re-FAP 2023-2024. Prix nettoyage Re-FAP hors main-d'œuvre. Garantie pack complet (garage) vs garantie nettoyage seul (dépôt). Efficacité mesurée sur banc de test homologué.</p>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section class="faq-section">
        <div class="container">
            <h2 style="text-align: center; margin-bottom: 40px;">Questions fréquentes</h2>
            
            <div class="faq-grid">
                <details class="faq-item">
                    <summary>Combien coûte le nettoyage FAP au total ?</summary>
                    <p>
                        Le nettoyage Re-FAP coûte 99-199€. Pour la solution clé en main en garage, ajoutez la main-d'œuvre (variable selon véhicule). 
                        Pour le dépôt en magasin, c'est le prix du nettoyage seul si vous gérez le démontage/remontage.
                    </p>
                </details>
                
                <details class="faq-item">
                    <summary>Mon véhicule passera-t-il le contrôle technique ?</summary>
                    <p>
                        Oui, le nettoyage Re-FAP restaure 98% de l'efficacité d'origine. Votre système antipollution sera conforme pour le CT et les zones ZFE.
                    </p>
                </details>
                
                <details class="faq-item">
                    <summary>Quelle est la durée de l'intervention ?</summary>
                    <p>
                        En garage partenaire : généralement une journée tout compris. 
                        En dépôt magasin : 4h si magasin équipé, 48h sinon (nettoyage seul, hors démontage/remontage).
                    </p>
                </details>
                
                <details class="faq-item">
                    <summary>Que couvre la garantie ?</summary>
                    <p>
                        1 an sur le nettoyage Re-FAP. En garage, la garantie couvre le pack complet (pièces et main-d'œuvre). 
                        En dépôt magasin, elle couvre uniquement le nettoyage.
                    </p>
                </details>
                
                <details class="faq-item">
                    <summary>Et si ce n'est pas le FAP ?</summary>
                    <p>
                        Le diagnostic en garage permettra d'identifier le vrai problème (capteur, vanne EGR, etc.) et de vous proposer la bonne solution.
                    </p>
                </details>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div style="display: flex; justify-content: center; margin-bottom: 30px;">
                <img src="assets/images/Re-Fap_Logo_Couleur.jpg" alt="Re-FAP - Technologie de nettoyage FAP" width="160" height="40" loading="lazy" decoding="async">
            </div>
            
            <p style="margin-bottom: 20px;">
                <a href="/mentions-legales" style="color: var(--white); margin: 0 10px;">Mentions légales</a>
                <a href="/protection-donnees" style="color: var(--white); margin: 0 10px;">Protection des données</a>
                <a href="/cgv" style="color: var(--white); margin: 0 10px;">CGV</a>
            </p>
            
            <p class="footer-note">
                Deux chemins, un même objectif : solutionner votre FAP au meilleur coût<br>
                © 2024 Re-FAP - Technologie de nettoyage FAP professionnelle
            </p>
        </div>
    </footer>

    <!-- Return Nudge - Recovery for quick bounces -->
    <div id="return-nudge" style="position:fixed;right:16px;bottom:16px;max-width:320px;background:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 8px 30px rgba(0,0,0,.15);display:none;z-index:1000">
        <strong>Besoin d'un coup de main ?</strong>
        <p style="margin:6px 0 10px;font-size:14px;color:var(--gray);">On vous oriente vers le bon garage en 30 s.</p>
        <div style="display:flex;gap:8px">
            <a href="#quiz" class="btn" style="flex:1;text-align:center;background:var(--primary);color:#fff;padding:10px;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px;" data-ga4_event="return_nudge_quiz">Voir ma recommandation</a>
            <a href="tel:0800737327" class="btn" style="flex:1;text-align:center;background:#eee;color:#111;padding:10px;border-radius:8px;text-decoration:none;font-weight:600;font-size:14px;" data-ga4_event="return_nudge_call">Appeler</a>
        </div>
    </div>

    <!-- Sticky Bottom Bar (Mobile) -->
    <div class="sticky-bar">
        <div class="sticky-bar-content">
            <button class="sticky-btn sticky-btn-primary" onclick="scrollToQuiz()" data-ga4_event="cta_quiz_mobile">
                🎯 Choisir ma voie
            </button>
            <a href="tel:0800737327" class="sticky-btn sticky-btn-secondary" data-ga4_event="cta_phone_click">
                📞 Appeler
            </a>
            <a href="https://autoai-re-fap-v2.vercel.app/" target="_blank" rel="noopener noreferrer" class="sticky-btn sticky-btn-secondary" data-ga4_event="cta_bot_click">
                🤖 Bot IA
            </a>
        </div>
    </div>

    <!-- Handoff Modal -->
    <div id="handoff-modal" class="handoff-modal" role="dialog" aria-modal="true" aria-labelledby="handoff-title" hidden>
        <div class="handoff-backdrop" data-close></div>
        <div class="handoff-dialog" role="document">
            <button class="handoff-close" aria-label="Fermer" data-close>&times;</button>
            <h3 id="handoff-title">📋 Ce qui va se passer sur notre site partenaire</h3>
            <p style="margin: 15px 0; color: var(--primary); font-weight: 600; text-align: center;">
                ✅ La prise de RDV diagnostic est sans engagement. Vous ne payez que si une intervention est nécessaire.
            </p>
            <p style="margin: 15px 0; color: var(--gray);">
                Pour obtenir votre diagnostic FAP et devis personnalisé :
            </p>
            <ol class="handoff-steps">
                <li><strong>Entrez votre immatriculation</strong> et <strong>code postal</strong><br>
                    <span style="font-size: 14px; color: var(--gray);">Pour identifier votre véhicule et localiser les garages proches</span>
                </li>
                <li><strong>Comparez les garages certifiés Re-FAP</strong><br>
                    <span style="font-size: 14px; color: var(--gray);">Prix, proximité, disponibilités, avis clients</span>
                </li>
                <li><strong>Prenez RDV pour un diagnostic</strong><br>
                    <span style="font-size: 14px; color: var(--gray);">Le garage proposera un devis tout compris si nettoyage nécessaire</span>
                </li>
            </ol>
            <p style="text-align: center; color: var(--primary); font-weight: 600; margin: 20px 0;">
                ✅ Vous restez libre de choisir le garage qui vous convient
            </p>
            <label class="handoff-optout">
                <input type="checkbox" id="handoff-skip"> Ne plus afficher ce message
            </label>
            <div class="handoff-actions">
                <button id="handoff-continue" class="btn-primary">Continuer vers IDGarages →</button>
                <button class="btn-secondary" data-close>Annuler</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Initialize dataLayer for GTM
        window.dataLayer = window.dataLayer || [];

        // Load saved quiz answers on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Restore quiz answers from localStorage
            ['q1', 'q2', 'q3'].forEach(k => {
                const v = localStorage.getItem('quiz_' + k);
                if (v) {
                    const input = document.querySelector(`input[name="${k}"][value="${v}"]`);
                    if (input) input.checked = true;
                }
            });
            
            // If we have saved route, show recommendation
            const savedRoute = localStorage.getItem('quiz_route');
            if (savedRoute) {
                showRecommendation(savedRoute);
                document.getElementById('modify-section').hidden = false;
            }
            
            // Mark IDGarages links for handoff
            document.querySelectorAll('a[data-ga4_event="cta_idgarages_click"]').forEach(a => {
                a.setAttribute('data-handoff', 'idgarages');
                a.setAttribute('target', '_blank');
                a.setAttribute('rel', 'noopener noreferrer');
            });
            
            // Update sticky bar if quiz completed
            const stickyBtn = document.querySelector('[data-ga4_event="cta_quiz_mobile"]');
            if (stickyBtn && localStorage.getItem('quiz_route')) {
                stickyBtn.textContent = '📌 Voir ma recommandation';
                stickyBtn.onclick = function() {
                    document.getElementById('recommendation').scrollIntoView({ behavior: 'smooth' });
                };
            }
            
            // Add rel="noopener noreferrer" to all external links
            document.querySelectorAll('a[href^="http"]:not([rel])').forEach(a => {
                a.setAttribute('rel', 'noopener noreferrer');
            });
        });
        
        // Prefetch IDGarages on hover for better perceived performance
        document.addEventListener('mouseover', function(e) {
            const a = e.target.closest('a[data-handoff="idgarages"]');
            if (!a || a.dataset.prefetched) return;
            
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = a.href;
            document.head.appendChild(link);
            a.dataset.prefetched = '1';
        });

        // Quiz validation and submission
        document.getElementById('micro-quiz').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Clear previous errors
            document.querySelectorAll('.error').forEach(err => err.hidden = true);
            
            // Validate each question
            let isValid = true;
            ['q1', 'q2', 'q3'].forEach(q => {
                if (!document.querySelector(`input[name="${q}"]:checked`)) {
                    document.getElementById(`${q}-error`).hidden = false;
                    isValid = false;
                }
            });
            
            if (!isValid) {
                // Focus on first error
                const firstErr = document.querySelector('.error:not([hidden])');
                if (firstErr) firstErr.focus();
                return;
            }
            
            // Get answers
            const q1 = document.querySelector('input[name="q1"]:checked').value;
            const q2 = document.querySelector('input[name="q2"]:checked').value;
            const q3 = document.querySelector('input[name="q3"]:checked').value;
            
            // Save to localStorage
            localStorage.setItem('quiz_q1', q1);
            localStorage.setItem('quiz_q2', q2);
            localStorage.setItem('quiz_q3', q3);
            
            // Decision logic
            let route = 'A'; // Default to IDGarages
            if (q1 === 'yes' || (q2 === 'no' && q3 === 'yes')) {
                route = 'B'; // Carter-Cash
            }
            
            // Save route
            localStorage.setItem('quiz_route', route);
            
            // Show recommendation
            showRecommendation(route);
            
            // Show modify link
            document.getElementById('modify-section').hidden = false;
            
            // Smooth scroll to recommendation
            document.getElementById('recommendation').scrollIntoView({ behavior: 'smooth' });
            
            // Track in GTM
            window.dataLayer.push({
                event: 'quiz_completed',
                quiz: {
                    q1: q1,
                    q2: q2,
                    q3: q3,
                    route: route
                }
            });
        });

        // Show recommendation function
        function showRecommendation(route) {
            let recommendationText = '';
            let points = [];
            let ctaUrl = '';
            let gaEvent = '';
            let ctaText = 'Accéder à la solution →';
            
            if (route === 'B') {
                // Route B: Dépôt magasin
                recommendationText = 'Vous avez un FAP déjà démonté ou êtes à l\'aise avec la mécanique.';
                points = [
                    'Solution économique (99-199€ pour le nettoyage)',
                    '94 magasins Carter-Cash partout en France',
                    'Sans rendez-vous, dépôt immédiat'
                ];
                ctaUrl = 'https://refap.github.io/carter-cash-refap/?utm_source=refap&utm_medium=quiz&utm_campaign=fap-depot';
                gaEvent = 'cta_cartercash_quiz';
                ctaText = 'Voir les magasins Carter-Cash →';
            } else {
                // Route A: IDGarages - Process détaillé
                recommendationText = 'Vous préférez une solution clé en main avec prise en charge complète.';
                points = [
                    '① Entrez votre immatriculation et code postal',
                    '② Comparez les garages certifiés Re-FAP (prix, proximité, disponibilités)',
                    '③ Prenez RDV pour un diagnostic (devis tout compris si nettoyage nécessaire)'
                ];
                ctaUrl = 'https://www.idgarages.com/fr-fr/prestations/diagnostic-electronique?utm_source=re-fap&utm_medium=partenariat&utm_campaign=diagnostic-electronique&ept-publisher=re-fap&ept-name=re-fap-diagnostic-electronique';
                gaEvent = 'cta_idgarages_quiz';
                ctaText = 'Prendre RDV pour un diagnostic →';
            }
            
            // Update recommendation section
            document.getElementById('recommendation-text').textContent = recommendationText;
            const pointsList = document.getElementById('recommendation-points');
            pointsList.innerHTML = '';
            points.forEach(point => {
                const li = document.createElement('li');
                li.innerHTML = point; // Use innerHTML to preserve formatting
                pointsList.appendChild(li);
            });
            
            // Update CTA
            const primaryCta = document.getElementById('primary-cta');
            primaryCta.href = ctaUrl;
            primaryCta.textContent = ctaText;
            primaryCta.setAttribute('data-ga4_event', gaEvent);
            
            // Add handoff attribute and target for route A
            if (route === 'A') {
                primaryCta.setAttribute('data-handoff', 'idgarages');
                primaryCta.setAttribute('target', '_blank');
                primaryCta.setAttribute('rel', 'noopener noreferrer');
                
                // Add "Why diagnosis?" explanation
                let whyDiag = document.querySelector('.why-diag');
                if (!whyDiag) {
                    whyDiag = document.createElement('p');
                    whyDiag.className = 'why-diag';
                    whyDiag.style.cssText = 'margin-top:15px;font-size:14px;color:var(--gray);text-align:center;';
                    primaryCta.parentNode.insertBefore(whyDiag, primaryCta.nextSibling);
                }
                whyDiag.innerHTML = 'Pourquoi un diagnostic ? Pour confirmer la cause (FAP vs capteur/EGR), éviter des dépenses inutiles, et obtenir un <strong>devis tout compris</strong> si un nettoyage est nécessaire.';
                
                // Add time/docs reassurance (Quick win 2)
                let whyMini = document.querySelector('.why-mini');
                if (!whyMini) {
                    whyMini = document.createElement('ul');
                    whyMini.className = 'why-mini';
                    whyMini.style.cssText = 'list-style:none;display:flex;justify-content:center;gap:30px;margin-top:10px;font-size:14px;color:var(--gray);';
                    whyDiag.parentNode.insertBefore(whyMini, whyDiag.nextSibling);
                }
                whyMini.innerHTML = '<li>📄 Carte grise sous la main</li><li>⏱️ Saisie 1-2 minutes</li>';
            } else {
                primaryCta.removeAttribute('data-handoff');
                primaryCta.removeAttribute('target');
                primaryCta.removeAttribute('rel');
                // Remove why-diag and why-mini if exists
                const whyDiag = document.querySelector('.why-diag');
                const whyMini = document.querySelector('.why-mini');
                if (whyDiag) whyDiag.remove();
                if (whyMini) whyMini.remove();
            }
            
            // Show recommendation section
            document.getElementById('recommendation').classList.add('active');
            
            // Inject inline FAQ (Quick win 5)
            injectInlineFAQ(route);
        }
        
        // Function to inject contextual FAQ
        function injectInlineFAQ(route) {
            const box = document.querySelector('.recommendation-box');
            let faq = document.querySelector('.faq-inline');
            if (faq) faq.remove();
            
            faq = document.createElement('div');
            faq.className = 'faq-inline';
            faq.style.cssText = 'margin-top:30px;padding-top:20px;border-top:1px solid #e0e0e0;';
            
            if (route === 'A') {
                faq.innerHTML = `
                    <h4 style="font-size:16px;margin-bottom:15px;color:var(--dark);">Questions fréquentes sur le diagnostic</h4>
                    <details style="margin-bottom:10px;">
                        <summary style="cursor:pointer;font-weight:600;padding:10px 0;">Pourquoi un diagnostic d'abord ?</summary>
                        <p style="padding:10px 0;color:var(--gray);">Il confirme la cause exacte et évite des dépenses inutiles. Le garage proposera un devis tout compris si un nettoyage est nécessaire.</p>
                    </details>
                    <details>
                        <summary style="cursor:pointer;font-weight:600;padding:10px 0;">Et si ce n'est pas le FAP ?</summary>
                        <p style="padding:10px 0;color:var(--gray);">Le diagnostic identifie la vraie cause (capteur, vanne EGR...) et oriente vers la réparation adaptée, vous évitant un remplacement inutile.</p>
                    </details>`;
            } else {
                faq.innerHTML = `
                    <h4 style="font-size:16px;margin-bottom:15px;color:var(--dark);">Questions fréquentes sur le dépôt</h4>
                    <details style="margin-bottom:10px;">
                        <summary style="cursor:pointer;font-weight:600;padding:10px 0;">Qui démonte/remonte ?</summary>
                        <p style="padding:10px 0;color:var(--gray);">Vous gérez ces opérations ou votre garagiste habituel. Le dépôt magasin concerne uniquement le nettoyage.</p>
                    </details>
                    <details>
                        <summary style="cursor:pointer;font-weight:600;padding:10px 0;">Qui fait la réinitialisation ?</summary>
                        <p style="padding:10px 0;color:var(--gray);">Elle est incluse en garage partenaire. En dépôt, elle reste à votre charge ou celle de votre mécanicien.</p>
                    </details>`;
            }
            
            box.appendChild(faq);
        }
        
        // Function for default recommendation (when user doesn't know)
        function showDefaultRecommendation() {
            // Set route A as default (clé en main) without bias
            localStorage.setItem('quiz_route', 'A');
            showRecommendation('A');
            document.getElementById('modify-section').hidden = false;
            document.getElementById('recommendation').scrollIntoView({ behavior: 'smooth' });
            
            // Track this special case
            window.dataLayer.push({
                event: 'quiz_default_route',
                route: 'A',
                reason: 'user_unsure'
            });
        }

        // Switch option function
        function switchOption() {
            const currentRoute = localStorage.getItem('quiz_route');
            const newRoute = currentRoute === 'A' ? 'B' : 'A';
            
            localStorage.setItem('quiz_route', newRoute);
            showRecommendation(newRoute);
            
            // Track switch
            window.dataLayer.push({
                event: 'option_switched',
                new_route: newRoute
            });
        }

        // Reset quiz function
        function resetQuiz() {
            // Clear localStorage including route (FIX: route was persisting)
            ['quiz_q1', 'quiz_q2', 'quiz_q3', 'quiz_route'].forEach(k => {
                localStorage.removeItem(k);
            });
            
            // Reset form
            document.getElementById('micro-quiz').reset();
            
            // Hide recommendation
            document.getElementById('recommendation').classList.remove('active');
            
            // Hide modify link
            document.getElementById('modify-section').hidden = true;
            
            // Scroll to quiz
            document.getElementById('quiz').scrollIntoView({ behavior: 'smooth' });
        }

        // Scroll to quiz function
        function scrollToQuiz() {
            document.getElementById('quiz').scrollIntoView({ behavior: 'smooth' });
        }

        // ========= Handoff Modal Management =========
        const modal = document.getElementById('handoff-modal');
        const btnContinue = document.getElementById('handoff-continue');
        const skipCheckbox = document.getElementById('handoff-skip');
        let pendingHref = null;
        let pendingOrigin = 'card'; // Track origin for analytics
        let lastFocused = null;

        function openHandoffModal(href, origin) {
            pendingHref = href;
            pendingOrigin = origin || 'card';
            lastFocused = document.activeElement;
            modal.hidden = false;
            
            // Focus management
            const dialogTitle = document.getElementById('handoff-title');
            dialogTitle.setAttribute('tabindex', '-1');
            dialogTitle.focus();
            
            // Track modal opening
            window.dataLayer.push({ 
                event: 'handoff_modal_open', 
                route: localStorage.getItem('quiz_route') || 'direct',
                origin: pendingOrigin
            });
        }

        function closeHandoffModal() {
            modal.hidden = true;
            if (lastFocused) lastFocused.focus();
        }

        // Intercept clicks on handoff links
        document.addEventListener('click', function(e) {
            // Check for handoff links
            const handoffLink = e.target.closest('a[data-handoff="idgarages"]');
            if (handoffLink) {
                // Determine origin for tracking
                const origin = (handoffLink.id === 'primary-cta') ? 'quiz'
                             : (handoffLink.closest('.sticky-bar') ? 'sticky' 
                             : (handoffLink.closest('.solution-card') ? 'card' : 'direct'));
                
                // Mark departure time for return tracking
                localStorage.setItem('last_handoff_click_at', Date.now());
                
                // Check if user has opted to skip modal (with TTL)
                const skipUntil = parseInt(localStorage.getItem('handoff_skip_until') || '0', 10);
                const skipActive = Date.now() < skipUntil;
                
                if (skipActive) {
                    // Track both direct click and cta_idgarages_click
                    window.dataLayer.push({ 
                        event: 'handoff_direct_click',
                        click_url: handoffLink.href
                    });
                    window.dataLayer.push({ 
                        event: 'cta_idgarages_click',
                        click_url: handoffLink.href,
                        route: localStorage.getItem('quiz_route') || 'A',
                        origin: origin
                    });
                    // Let the link proceed normally (will open in new tab)
                    return;
                }
                
                // Prevent default and show modal
                e.preventDefault();
                openHandoffModal(handoffLink.href, origin);
                return;
            }
            
            // Existing GA4 tracking with origin field
            const el = e.target.closest('[data-ga4_event]');
            if (el && !el.hasAttribute('data-handoff')) {
                const eventName = el.getAttribute('data-ga4_event');
                const href = el.getAttribute('href');
                const route = localStorage.getItem('quiz_route') || null;
                
                // Determine origin
                let origin = 'direct';
                if (el.id === 'primary-cta') origin = 'quiz';
                else if (el.closest('.solution-card')) origin = 'card';
                else if (el.closest('.sticky-bar')) origin = 'sticky';
                
                window.dataLayer.push({
                    event: eventName,
                    click_url: href,
                    route: route,
                    origin: origin
                });
            }
        });

        // Continue button in modal
        if (btnContinue) {
            btnContinue.addEventListener('click', function() {
                // Check if user wants to skip in future (Quick win 3 - TTL 30 days)
                if (skipCheckbox && skipCheckbox.checked) {
                    const ttl = Date.now() + 30 * 24 * 60 * 60 * 1000; // 30 days
                    localStorage.setItem('handoff_skip_until', String(ttl));
                    window.dataLayer.push({ event: 'handoff_skip_forever', ttl_days: 30 });
                }
                
                // Track continue action
                window.dataLayer.push({ 
                    event: 'handoff_continue_idgarages',
                    click_url: pendingHref,
                    origin: pendingOrigin
                });
                
                // PATCH: Also push the standard CTA event for unified tracking
                window.dataLayer.push({
                    event: 'cta_idgarages_click',
                    click_url: pendingHref,
                    route: localStorage.getItem('quiz_route') || 'A',
                    origin: pendingOrigin
                });
                
                // Quick win 4 - Event before leaving
                window.dataLayer.push({ 
                    event: 'handoff_before_leaving',
                    click_url: pendingHref
                });
                
                // Open in new tab
                window.open(pendingHref, '_blank', 'noopener');
                closeHandoffModal();
            });
        }

        // Close modal handlers
        modal.addEventListener('click', function(e) {
            if (e.target.hasAttribute('data-close')) {
                window.dataLayer.push({ event: 'handoff_cancel' });
                closeHandoffModal();
            }
        });

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (!modal.hidden && e.key === 'Escape') {
                window.dataLayer.push({ event: 'handoff_cancel' });
                closeHandoffModal();
            }
        });

        // Focus trap in modal (accessibility)
        modal.addEventListener('keydown', function(e) {
            if (e.key === 'Tab' && !modal.hidden) {
                const focusableElements = modal.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey && document.activeElement === firstElement) {
                    lastElement.focus();
                    e.preventDefault();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    firstElement.focus();
                    e.preventDefault();
                }
            }
        });
        
        // Return Nudge Detection - Show nudge if user returns within 90s
        (function() {
            const KEY = 'last_handoff_click_at';
            
            // Check if user is returning quickly after handoff
            const lastHandoff = parseInt(localStorage.getItem(KEY) || '0', 10);
            if (lastHandoff && (Date.now() - lastHandoff < 90000)) {
                const nudge = document.getElementById('return-nudge');
                if (nudge) {
                    nudge.style.display = 'block';
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        event: 'return_quick_after_handoff',
                        delta_ms: Date.now() - lastHandoff
                    });
                    
                    // Auto-hide after 30 seconds
                    setTimeout(() => {
                        nudge.style.display = 'none';
                    }, 30000);
                }
            }
        })();
    </script>
</body>
</html>
